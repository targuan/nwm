<!DOCTYPE html>
<html>
<head>
<style>
html {
  height: 100%;
}
body {
  height: 100%;
  margin: 0;
  padding: 0;
}
#flex-container {
    display: flex;
    width: 100%;
    height: 100%;
}
#context-menu {
    height: 100%;
    width: 300px;
    background-color: red;
    background-color: lightgrey;
    box-shadow: -5px 0px 5px grey ;
} 
#map-container {
    flex-grow: 1;
}
.link {

    fill:blue;
    stroke: black;
    stroke-width:5;
    stroke-opacity: 0.5;
}
.path-quad {
    fill:none;
    stroke: blue;
    stroke-width:5;
    stroke-opacity: 0.5;
}
.path-cubic {
    fill:none;
    stroke: red;
    stroke-width:5;
    stroke-opacity: 0.5;
}
.path-linear {
    fill:none;
    stroke: green;
    stroke-width:5;
    stroke-opacity: 0.5;
}
.skel {
    fill:none;
    stroke: red;
    stroke-width:1;
    stroke-opacity: 0.5;
}
.not-selected {
    opacity: 0.5;
}
.viapoint {
    cursor: move;
}
.node {
    cursor: move;
    fill: red;
}
.node .border {
    fill: red;
    fill-opacity: 0.01;
    stroke: red;
}
input {
    padding:8px;
    display:block;
    border:none;
    border-bottom:1px solid black;
    box-sizing:border-box;
    width:100%
}
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="models.js"></script>
<script src="parser.js"></script>
<script>
var DEBUG = false

function clearSelection() {
    d3.selectAll('.not-selected').classed('not-selected', false)
    d3.selectAll('.selected').classed('selected', false)
    
    d3.selectAll('#map').selectAll('.viapoint').data([]).exit().remove()
    d3.select("#context-menu").selectAll('p').data([]).exit().remove()
}

function updateAll() {   
    updateLinkSelection(d3.selectAll('.link'))
    updateNodeSelection(d3.selectAll('.node'))
    
}

function updateLinkSelection(selection) {
    selection.each(
        function(d){
            d3.select(this).select('.skel').attr('d', d3helper.skelPath)
            d3.select(this).select('.edge').attr('d', d3helper.arrowPath)
        }
    )
}

function updateNodeSelection(selection) {
    selection.attr("transform", function(d) { 
            text = this.getElementsByClassName("name")[0]
            bbox = text.getBBox()
            return "translate(" + (d.position.x - bbox.width/2) + "," + (d.position.y - bbox.y/2 - bbox.height/2 ) +")" 
        })
        .on("click", selectNode)
        .call(d3.drag().on("drag", dragNode))
    
    d3.selectAll(".node .border").each(function(){
        rect = d3.select(this)
        
        text = this.parentNode.getElementsByClassName("name")[0]
        bbox = text.getBBox()
        rect.attr( "x", bbox.x - 5)
            .attr("y", bbox.y - 5)
            .attr("width",bbox.width + 10)
            .attr("height", bbox.height + 10)
    })
}


function dragNode(d) {
    selectElement(this,d)
    d.position.x += d3.event.dx
    d.position.y += d3.event.dy
    
    updateAll(d.map)
}

function dragViapoint(d) {
    d.x += d3.event.dx
    d.y += d3.event.dy
    
    var viapoint = d3.select(this).datum(d)
    viapoint.merge(viapoint)
        .attr('r', 5)
        .attr('cx', function(d){ return d.x })
        .attr('cy', function(d){ return d.y })
        .call(d3.drag().on("drag", dragViapoint))
    
    updateAll(d.map)
}

function selectElement(element, d) {
    d3.selectAll('.node, .link').classed('not-selected', true)
    d3.select(element).classed('selected', true).classed('not-selected', false)
    d3.select("context-menu").datum(d)
}
function selectNode(d) {
    selectElement(this, d)
    d3.event.stopPropagation();
    
    
}
function selectLink(d) {
    selectElement(this, d)
    d3.event.stopPropagation();
    
    var viapoints = d3.select('#map').selectAll('.viapoint').data(d.via)
    
    viapoints.exit().remove()
    viapoints.enter().append('circle').classed('viapoint', true)
        .call(d3.drag().on("drag", dragViapoint))
        .merge(viapoints)
        .attr('r', 5)
        .attr('cx', function(d){ return d.x })
        .attr('cy', function(d){ return d.y })
        
}

window.onload = function() {
    d3.select("body")
        .on("keydown", function(d) { if(d3.event.keyCode == 27) { clearSelection() }})
    map = new Map();
    a = new Node("azerty\ntoto", new Point(150,130))
    z = new Node("z", new Point(500,10))
    link = new Link(a,z)
    link.addVia(new Point(200,200))
    link.addVia(new Point(300,400))

    map.addNode(a)
    map.addNode(z)
    map.addLink(link)
    
    d3.select("#map-container").on("click", function(){ console.log('click');clearSelection() })
    var svg = d3.select("#map-container").append("svg")
        .attr("width", "100%")
        .attr("height","100%")
        .append("g")
        .attr('id', 'map')
        
    links = svg.selectAll(".link").data(map.links)
    links.enter().append(function(d,e,f) {
        var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        
        var skel = document.createElementNS("http://www.w3.org/2000/svg", "path");
        skel.setAttribute('d', d3helper.skelPath(d))
        skel.setAttribute('class', "skel")
        g.append(skel)
        
        var path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute('d', d3helper.arrowPath(d))
        path.setAttribute('class', "edge")
        g.append(path)
        
        
        return g
    })
      .attr("class", "link")
      .on("click", selectLink)
      
    nodes = svg.selectAll(".node").data(map.nodes)
    nodes.enter().append(function(d,e,f) {
            var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            
            var text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("class", "name")
            text.textContent = d.name
            g.append(text)
            
            var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("class", "border")
            g.append(rect)
            
            return g
        })
        .attr("class", "node")
        .call(updateNodeSelection)
    
}
</script>
</head>
<body>
<div id="flex-container">
    <div id="map-container">

    </div>
    <div id="context-menu">
    
    </div>
</div>
</body>
</html>